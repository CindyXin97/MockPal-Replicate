# é‚®ä»¶å‘é€é¢‘ç‡é™åˆ¶åŠŸèƒ½

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ä¸ºäº†é˜²æ­¢é‚®ä»¶æ»¥ç”¨å’Œä¿æŠ¤ç”¨æˆ·ä½“éªŒï¼Œç³»ç»Ÿç°åœ¨å®æ–½äº†é‚®ä»¶å‘é€é¢‘ç‡é™åˆ¶ï¼š

**æ¯ä¸ªç”¨æˆ·æ¯å‘¨æœ€å¤šæ”¶åˆ° 2 å°é‚®ä»¶**

## ğŸ¯ é™åˆ¶è§„åˆ™

### æ—¶é—´çª—å£
- **7å¤©æ»šåŠ¨çª—å£**ï¼šä»å½“å‰æ—¶é—´å¾€å‰æ¨ç®—7å¤©
- ä¸æ˜¯æŒ‰è‡ªç„¶å‘¨ï¼ˆå‘¨ä¸€åˆ°å‘¨æ—¥ï¼‰ï¼Œè€Œæ˜¯è¿ç»­çš„168å°æ—¶

### è®¡æ•°è§„åˆ™
- åªè®¡ç®—**æˆåŠŸå‘é€**çš„é‚®ä»¶ï¼ˆ`status = 'sent'`ï¼‰
- ä¸è®¡ç®—å¤±è´¥çš„é‚®ä»¶ï¼ˆ`status = 'failed'`ï¼‰
- ä¸è®¡ç®—è¢«è·³è¿‡çš„é‚®ä»¶ï¼ˆ`status = 'skipped'`ï¼‰

### é™åˆ¶æ•°é‡
- **2å°/å‘¨**ï¼šä»»æ„7å¤©å†…æœ€å¤š2å°é‚®ä»¶

---

## ğŸ“Š é‚®ä»¶ç±»å‹

ç³»ç»Ÿè·Ÿè¸ªä¸‰ç§é‚®ä»¶ç±»å‹ï¼š

| é‚®ä»¶ç±»å‹ | æ ‡è¯†ç¬¦ | è§¦å‘åœºæ™¯ | è¶…é™è¡Œä¸º |
|---------|-------|---------|---------|
| **ç™»å½•éªŒè¯** | `login` | ç”¨æˆ·é€‰æ‹©é‚®ç®±ç™»å½•æ—¶ | æŠ›å‡ºé”™è¯¯ï¼Œæç¤ºç”¨æˆ· |
| **è®¾ç½®å¯†ç ** | `password_setup` | æ–°ç”¨æˆ·æ³¨å†Œæ—¶ | æŠ›å‡ºé”™è¯¯ï¼Œæç¤ºç”¨æˆ· |
| **åŒ¹é…æˆåŠŸ** | `match_success` | åŒæ–¹äº’ç›¸ç‚¹èµæˆåŠŸæ—¶ | é™é»˜è·³è¿‡ï¼Œä¸å½±å“åŒ¹é… |

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### æ–°å¢è¡¨ï¼š`email_send_logs`

```sql
CREATE TABLE email_send_logs (
  id SERIAL PRIMARY KEY,
  recipient_email VARCHAR(255) NOT NULL,    -- æ”¶ä»¶äººé‚®ç®±
  email_type VARCHAR(50) NOT NULL,          -- é‚®ä»¶ç±»å‹
  subject VARCHAR(255),                     -- é‚®ä»¶ä¸»é¢˜
  status VARCHAR(20) NOT NULL DEFAULT 'sent', -- å‘é€çŠ¶æ€
  error_message TEXT,                       -- é”™è¯¯ä¿¡æ¯
  sent_at TIMESTAMP NOT NULL DEFAULT NOW()  -- å‘é€æ—¶é—´
);

-- ç´¢å¼•
CREATE INDEX idx_email_send_logs_recipient_sent_at 
  ON email_send_logs(recipient_email, sent_at);
CREATE INDEX idx_email_send_logs_email_type 
  ON email_send_logs(email_type);
```

### å­—æ®µè¯´æ˜

- **recipient_email**: æ¥æ”¶é‚®ä»¶çš„é‚®ç®±åœ°å€
- **email_type**: é‚®ä»¶ç±»å‹ï¼ˆlogin, password_setup, match_successï¼‰
- **subject**: é‚®ä»¶ä¸»é¢˜ï¼ˆä¾¿äºå®¡è®¡ï¼‰
- **status**: å‘é€çŠ¶æ€
  - `sent`: å‘é€æˆåŠŸ
  - `failed`: å‘é€å¤±è´¥
  - `skipped`: å› è¶…é™è¢«è·³è¿‡
- **error_message**: å¦‚æœå¤±è´¥æˆ–è·³è¿‡ï¼Œè®°å½•åŸå› 
- **sent_at**: é‚®ä»¶å‘é€æ—¶é—´ï¼ˆç”¨äºè®¡ç®—é¢‘ç‡ï¼‰

---

## ğŸ’» å®ç°ç»†èŠ‚

### æ ¸å¿ƒé€»è¾‘

```typescript
// 1. æ£€æŸ¥é¢‘ç‡é™åˆ¶
private async checkEmailRateLimit(
  email: string, 
  emailType: string
): Promise<{ allowed: boolean; message?: string; sentCount?: number }>

// 2. è®°å½•é‚®ä»¶å‘é€
private async logEmailSend(
  email: string,
  emailType: string,
  subject: string,
  status: 'sent' | 'failed' | 'skipped',
  errorMessage?: string
): Promise<void>
```

### æ‰§è¡Œæµç¨‹

```
1. ç”¨æˆ·è§¦å‘é‚®ä»¶å‘é€
   â†“
2. æ£€æŸ¥å¼€å‘ç¯å¢ƒï¼Ÿ
   â”œâ”€ æ˜¯ â†’ è·³è¿‡é™åˆ¶ï¼Œæ‰“å°åˆ°æ§åˆ¶å°
   â””â”€ å¦ â†’ ç»§ç»­
   â†“
3. è°ƒç”¨ checkEmailRateLimit()
   â”œâ”€ æŸ¥è¯¢è¿‡å»7å¤©å†…å‘é€ç»™è¯¥é‚®ç®±çš„é‚®ä»¶æ•°
   â””â”€ åˆ¤æ–­æ˜¯å¦ >= 2
   â†“
4. æ˜¯å¦è¶…é™ï¼Ÿ
   â”œâ”€ æ˜¯ â†’ è®°å½• skippedï¼Œè¿”å›/æŠ›å‡ºé”™è¯¯
   â””â”€ å¦ â†’ ç»§ç»­å‘é€
   â†“
5. è°ƒç”¨ Resend API å‘é€
   â†“
6. æˆåŠŸï¼Ÿ
   â”œâ”€ æ˜¯ â†’ è®°å½• sent
   â””â”€ å¦ â†’ è®°å½• failedï¼ŒæŠ›å‡ºé”™è¯¯
```

---

## ğŸ­ ä¸åŒé‚®ä»¶ç±»å‹çš„å¤„ç†

### 1. ç™»å½•éªŒè¯é‚®ä»¶ï¼ˆloginï¼‰

**è¶…é™è¡Œä¸º**ï¼šæŠ›å‡ºé”™è¯¯

```typescript
if (!rateLimitCheck.allowed) {
  await this.logEmailSend(email, 'login', 'MockPal - ç™»å½•éªŒè¯', 'skipped', ...);
  throw new Error(`é‚®ä»¶å‘é€å·²è¾¾åˆ°é™åˆ¶ï¼š${rateLimitCheck.message}`);
}
```

**ç”¨æˆ·ä½“éªŒ**ï¼š
- ç”¨æˆ·ä¼šçœ‹åˆ°é”™è¯¯æç¤º
- å»ºè®®ç­‰å¾…ä¸€æ®µæ—¶é—´åå†è¯•
- æˆ–ä½¿ç”¨å…¶ä»–ç™»å½•æ–¹å¼ï¼ˆGoogle OAuthï¼‰

---

### 2. è®¾ç½®å¯†ç é‚®ä»¶ï¼ˆpassword_setupï¼‰

**è¶…é™è¡Œä¸º**ï¼šæŠ›å‡ºé”™è¯¯

```typescript
if (!rateLimitCheck.allowed) {
  await this.logEmailSend(email, 'password_setup', 'MockPal - è®¾ç½®å¯†ç ', 'skipped', ...);
  throw new Error(`é‚®ä»¶å‘é€å·²è¾¾åˆ°é™åˆ¶ï¼š${rateLimitCheck.message}`);
}
```

**ç”¨æˆ·ä½“éªŒ**ï¼š
- ç”¨æˆ·ä¼šçœ‹åˆ°é”™è¯¯æç¤º
- å»ºè®®ä½¿ç”¨é‚®ç®±éªŒè¯ç™»å½•ï¼ˆå¦‚æœå·²æœ‰è´¦å·ï¼‰
- æˆ–ç­‰å¾…é™åˆ¶é‡ç½®

---

### 3. åŒ¹é…æˆåŠŸé€šçŸ¥ï¼ˆmatch_successï¼‰

**è¶…é™è¡Œä¸º**ï¼šé™é»˜è·³è¿‡

```typescript
if (!rateLimitCheck.allowed) {
  await this.logEmailSend(to, 'match_success', 'MockPal - åŒ¹é…æˆåŠŸé€šçŸ¥', 'skipped', ...);
  return { 
    data: { id: 'rate-limit-skip' }, 
    error: null,
    skipped: true,
    reason: 'rate_limit'
  };
}
```

**ç”¨æˆ·ä½“éªŒ**ï¼š
- **åŒ¹é…ä»ç„¶æˆåŠŸ**
- åªæ˜¯ä¸å‘é€é‚®ä»¶é€šçŸ¥
- ç”¨æˆ·å¯ä»¥åœ¨ç½‘ç«™ä¸Šçœ‹åˆ°åŒ¹é…ç»“æœ
- ä¸å½±å“æ ¸å¿ƒä¸šåŠ¡æµç¨‹

**è®¾è®¡ç†ç”±**ï¼š
- åŒ¹é…æˆåŠŸé€šçŸ¥æ˜¯**éå…³é”®é‚®ä»¶**
- ä¼˜å…ˆä¿éšœç™»å½•å’Œæ³¨å†Œé‚®ä»¶
- é¿å…å› é€šçŸ¥é‚®ä»¶æ¶ˆè€—é…é¢

---

## ğŸ“ˆ ç»Ÿè®¡å’Œç›‘æ§

### æŸ¥è¯¢å‘é€ç»Ÿè®¡

```sql
-- æŸ¥çœ‹æŸä¸ªé‚®ç®±çš„å‘é€å†å²
SELECT * FROM email_send_logs
WHERE recipient_email = 'user@example.com'
ORDER BY sent_at DESC;

-- æŸ¥çœ‹è¿‡å»7å¤©çš„å‘é€ç»Ÿè®¡
SELECT 
  email_type,
  status,
  COUNT(*) as count
FROM email_send_logs
WHERE sent_at >= NOW() - INTERVAL '7 days'
GROUP BY email_type, status;

-- æŸ¥çœ‹è¢«è·³è¿‡çš„é‚®ä»¶ï¼ˆè¶…é™ï¼‰
SELECT * FROM email_send_logs
WHERE status = 'skipped'
  AND sent_at >= NOW() - INTERVAL '7 days'
ORDER BY sent_at DESC;
```

---

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

### 1. å®¹é”™æœºåˆ¶

```typescript
// å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œé»˜è®¤å…è®¸å‘é€ï¼ˆé¿å…å½±å“æ­£å¸¸ä¸šåŠ¡ï¼‰
return { allowed: true };
```

**è®¾è®¡ç†ç”±**ï¼š
- æ•°æ®åº“è¿æ¥å¤±è´¥æ—¶ä¸åº”é˜»æ­¢é‚®ä»¶å‘é€
- ä¿éšœæ ¸å¿ƒä¸šåŠ¡è¿ç»­æ€§
- è®°å½•å¤±è´¥ä¸å½±å“ä¸»æµç¨‹

### 2. åªè®¡ç®—æˆåŠŸå‘é€

```sql
eq(emailSendLogs.status, 'sent') -- åªè®¡ç®—æˆåŠŸå‘é€çš„
```

**è®¾è®¡ç†ç”±**ï¼š
- å¤±è´¥çš„é‚®ä»¶ä¸åº”è®¡å…¥é…é¢
- é¿å…ç”¨æˆ·å› ç³»ç»Ÿé”™è¯¯è¢«é™åˆ¶

### 3. å¼€å‘ç¯å¢ƒè±å…

```typescript
if (process.env.NODE_ENV === 'development') {
  // è·³è¿‡æ‰€æœ‰é™åˆ¶
  return { data: { id: 'dev-mode-skip' }, error: null };
}
```

**è®¾è®¡ç†ç”±**ï¼š
- å¼€å‘è°ƒè¯•ä¸æ¶ˆè€—é…é¢
- ä¸å½±å“ç”Ÿäº§æ•°æ®

---

## ğŸ”§ é…ç½®å’Œè°ƒæ•´

### è°ƒæ•´é™åˆ¶æ•°é‡

ä¿®æ”¹ `lib/email-service.ts` ç¬¬46è¡Œï¼š

```typescript
if (sentCount >= 2) {  // ä¿®æ”¹è¿™ä¸ªæ•°å­—
  return { allowed: false, ... };
}
```

### è°ƒæ•´æ—¶é—´çª—å£

ä¿®æ”¹ `lib/email-service.ts` ç¬¬29-30è¡Œï¼š

```typescript
const sevenDaysAgo = new Date();
sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);  // ä¿®æ”¹å¤©æ•°
```

---

## ğŸ“Š ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šæ­£å¸¸å‘é€

```
ç”¨æˆ·: user@example.com
è¿‡å»7å¤©å‘é€: 1å°

è¯·æ±‚: ç™»å½•éªŒè¯é‚®ä»¶
ç»“æœ: âœ… å‘é€æˆåŠŸï¼ˆ1/2ï¼‰
```

### ç¤ºä¾‹2ï¼šè¾¾åˆ°é™åˆ¶

```
ç”¨æˆ·: user@example.com
è¿‡å»7å¤©å‘é€: 2å°

è¯·æ±‚: ç™»å½•éªŒè¯é‚®ä»¶
ç»“æœ: âŒ è¶…é™ï¼ŒæŠ›å‡ºé”™è¯¯
æ—¥å¿—: status='skipped', error_message='è¯¥é‚®ç®±åœ¨è¿‡å»7å¤©å†…å·²æ”¶åˆ°2å°é‚®ä»¶'
```

### ç¤ºä¾‹3ï¼šåŒ¹é…æˆåŠŸé€šçŸ¥é™é»˜è·³è¿‡

```
ç”¨æˆ·: user@example.com
è¿‡å»7å¤©å‘é€: 2å°

è¯·æ±‚: åŒ¹é…æˆåŠŸé€šçŸ¥
ç»“æœ: âœ… åŒ¹é…æˆåŠŸï¼ˆä½†ä¸å‘é€é‚®ä»¶ï¼‰
æ—¥å¿—: status='skipped', error_message='å·²è¾¾åˆ°æ¯å‘¨é™åˆ¶'
ç”¨æˆ·: ä»ç„¶å¯ä»¥åœ¨ç½‘ç«™ä¸Šçœ‹åˆ°åŒ¹é…
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. è¿è¡Œæ•°æ®åº“è¿ç§»

```bash
# åœ¨ç”Ÿäº§æ•°æ®åº“è¿è¡Œ
psql $DATABASE_URL -f migrations/0014_add_email_send_logs.sql
```

### 2. éªŒè¯è¡¨åˆ›å»º

```sql
-- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
\dt email_send_logs

-- æ£€æŸ¥ç´¢å¼•
\di idx_email_send_logs_*
```

### 3. æµ‹è¯•åŠŸèƒ½

```bash
# å¼€å‘ç¯å¢ƒæµ‹è¯•ï¼ˆä¸å—é™åˆ¶ï¼‰
npm run dev

# ç”Ÿäº§ç¯å¢ƒæµ‹è¯•
npm run build
npm start
```

---

## ğŸ“ FAQ

### Q1: ä¸ºä»€ä¹ˆæ˜¯æ¯å‘¨2å°è€Œä¸æ˜¯æ›´å¤šï¼Ÿ

A: 
- è€ƒè™‘åˆ° Resend å…è´¹ç‰ˆæ¯æœˆ100å°é™åˆ¶
- å¹³è¡¡ç”¨æˆ·ä½“éªŒå’Œèµ„æºæ¶ˆè€—
- å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´

### Q2: åŒ¹é…æˆåŠŸé€šçŸ¥ä¸ºä»€ä¹ˆé™é»˜è·³è¿‡ï¼Ÿ

A:
- åŒ¹é…åŠŸèƒ½æœ¬èº«ä¸å—å½±å“
- ç”¨æˆ·å¯ä»¥åœ¨ç½‘ç«™æŸ¥çœ‹
- ä¼˜å…ˆä¿éšœç™»å½•ç­‰å…³é”®é‚®ä»¶

### Q3: ç”¨æˆ·å¦‚ä½•çŸ¥é“è¢«é™åˆ¶äº†ï¼Ÿ

A:
- ç™»å½•/æ³¨å†Œé‚®ä»¶ï¼šä¼šæ˜¾ç¤ºé”™è¯¯æç¤º
- åŒ¹é…é€šçŸ¥ï¼šä¸æ˜¾ç¤ºï¼ˆé™é»˜ï¼‰

### Q4: é™åˆ¶ä½•æ—¶é‡ç½®ï¼Ÿ

A:
- 7å¤©æ»šåŠ¨çª—å£ï¼Œä¸æ˜¯å›ºå®šå‘¨æœŸ
- ä¾‹å¦‚ï¼šå‘¨ä¸€å‘2å°ï¼Œä¸‹å‘¨ä¸€è‡ªåŠ¨é‡ç½®

### Q5: ä¼šå½±å“å·²æœ‰ç”¨æˆ·å—ï¼Ÿ

A:
- ä¸ä¼šï¼Œä»éƒ¨ç½²åå¼€å§‹è®¡æ•°
- å†å²é‚®ä»¶ä¸è®¡å…¥

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. ç›‘æ§è¶…é™æƒ…å†µ

å®šæœŸæ£€æŸ¥è¢«è·³è¿‡çš„é‚®ä»¶ï¼š

```sql
SELECT 
  recipient_email, 
  COUNT(*) as skipped_count
FROM email_send_logs
WHERE status = 'skipped'
  AND sent_at >= NOW() - INTERVAL '30 days'
GROUP BY recipient_email
HAVING COUNT(*) > 5
ORDER BY skipped_count DESC;
```

### 2. ä¼˜åŒ–ç”¨æˆ·å¼•å¯¼

- æç¤ºç”¨æˆ·ä½¿ç”¨ Google ç™»å½•ï¼ˆä¸æ¶ˆè€—é‚®ä»¶é…é¢ï¼‰
- åœ¨è¶…é™æ—¶æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
- è€ƒè™‘æ·»åŠ "é™åˆ¶å°†åœ¨Xå¤©åé‡ç½®"çš„æç¤º

### 3. å®šæœŸæ¸…ç†

æ—§æ•°æ®ä¸å½±å“åŠŸèƒ½ï¼Œä½†å¯ä»¥å®šæœŸæ¸…ç†ï¼š

```sql
-- ä¿ç•™90å¤©æ•°æ®
DELETE FROM email_send_logs
WHERE sent_at < NOW() - INTERVAL '90 days';
```

---

ç”Ÿæˆæ—¶é—´ï¼š2025-10-17  
ç›¸å…³æ–‡ä»¶ï¼š
- `lib/email-service.ts` - æ ¸å¿ƒé€»è¾‘
- `lib/db/schema.ts` - æ•°æ®åº“Schema
- `migrations/0014_add_email_send_logs.sql` - æ•°æ®åº“è¿ç§»

