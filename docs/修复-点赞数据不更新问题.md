# ä¿®å¤ï¼šç‚¹èµæˆåŠŸåå‰ç«¯ä¸æ˜¾ç¤ºæ›´æ–° ğŸ”§

## âŒ é—®é¢˜æè¿°

**ç—‡çŠ¶**ï¼š
- ç”¨æˆ·ç‚¹å‡»ç‚¹èµæŒ‰é’®
- æ˜¾ç¤º "ç‚¹èµæˆåŠŸ" æç¤º
- ä½†æ˜¯ç‚¹èµæ•°å­—æ²¡æœ‰å˜åŒ–ï¼ˆä»ç„¶æ˜¾ç¤º 0ï¼‰

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 

è¿™æ˜¯ä¸€ä¸ªç»å…¸çš„ **React State åŒæ­¥é—®é¢˜**ã€‚

**é—®é¢˜ä»£ç **ï¼š
```typescript
export function VoteButtons({ initialUpvotes, initialDownvotes, initialUserVote }: Props) {
  const [upvotes, setUpvotes] = useState(initialUpvotes);
  const [downvotes, setDownvotes] = useState(initialDownvotes);
  const [userVote, setUserVote] = useState(initialUserVote);
  
  // ... ç‚¹èµé€»è¾‘
}
```

**é—®é¢˜æµç¨‹**ï¼š
```
1. ç»„ä»¶é¦–æ¬¡æ¸²æŸ“
   initialUpvotes = 0 â†’ upvotes state = 0
   
2. ç”¨æˆ·ç‚¹å‡»ç‚¹èµ
   API æˆåŠŸ â†’ setUpvotes(1) â†’ upvotes state = 1 âœ…
   è°ƒç”¨ onVoteChange() â†’ çˆ¶ç»„ä»¶é‡æ–°è·å–æ•°æ®
   
3. çˆ¶ç»„ä»¶æ¥æ”¶åˆ°æ–°æ•°æ®
   question.stats.upvotes = 1
   ä¼ å…¥æ–°çš„ props: initialUpvotes = 1
   
4. âŒ é—®é¢˜ï¼šVoteButtons ç»„ä»¶çš„ state ä¸ä¼šè‡ªåŠ¨æ›´æ–°ï¼
   useState åªåœ¨ç»„ä»¶é¦–æ¬¡æŒ‚è½½æ—¶ä½¿ç”¨åˆå§‹å€¼
   åç»­ props å˜åŒ–ä¸ä¼šè§¦å‘ state æ›´æ–°
```

### ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ

React çš„ `useState` hook çš„åˆå§‹å€¼**åªåœ¨ç»„ä»¶é¦–æ¬¡æ¸²æŸ“æ—¶ä½¿ç”¨**ã€‚

```typescript
const [count, setCount] = useState(initialCount);

// å³ä½¿ initialCount ä» 0 å˜æˆ 10
// count çš„å€¼ä»ç„¶ä¿æŒä¸å˜
// é™¤éä½ æ‰‹åŠ¨è°ƒç”¨ setCount(10)
```

## âœ… è§£å†³æ–¹æ¡ˆ

ä½¿ç”¨ `useEffect` ç›‘å¬ props å˜åŒ–ï¼Œå½“çˆ¶ç»„ä»¶ä¼ å…¥æ–°å€¼æ—¶åŒæ­¥æ›´æ–° stateã€‚

### ä¿®å¤ä»£ç 

```typescript
import { useState, useEffect } from 'react';

export function VoteButtons({
  initialUpvotes,
  initialDownvotes,
  initialUserVote,
  onVoteChange,
}: VoteButtonsProps) {
  const [upvotes, setUpvotes] = useState(initialUpvotes);
  const [downvotes, setDownvotes] = useState(initialDownvotes);
  const [userVote, setUserVote] = useState(initialUserVote);
  
  // ğŸ”§ å…³é”®ä¿®å¤ï¼šåŒæ­¥ props åˆ° state
  useEffect(() => {
    setUpvotes(initialUpvotes);
    setDownvotes(initialDownvotes);
    setUserVote(initialUserVote);
  }, [initialUpvotes, initialDownvotes, initialUserVote]);
  
  // ... å…¶ä»–é€»è¾‘
}
```

### å·¥ä½œæµç¨‹ï¼ˆä¿®å¤åï¼‰

```
1. ç»„ä»¶é¦–æ¬¡æ¸²æŸ“
   initialUpvotes = 0 â†’ upvotes state = 0
   
2. ç”¨æˆ·ç‚¹å‡»ç‚¹èµ
   setUpvotes(1) â†’ upvotes state = 1 âœ… [ç«‹å³æ˜¾ç¤º]
   è°ƒç”¨ onVoteChange() â†’ çˆ¶ç»„ä»¶é‡æ–°è·å–æ•°æ®
   
3. çˆ¶ç»„ä»¶æ¥æ”¶åˆ°æ–°æ•°æ®
   question.stats.upvotes = 1
   ä¼ å…¥æ–°çš„ props: initialUpvotes = 1
   
4. âœ… useEffect æ£€æµ‹åˆ° props å˜åŒ–
   æ‰§è¡Œï¼šsetUpvotes(1)
   ç¡®ä¿æœ¬åœ° state ä¸æœåŠ¡å™¨æ•°æ®åŒæ­¥
```

## ğŸ¯ æŠ€æœ¯ç»†èŠ‚

### ä¸ºä»€ä¹ˆéœ€è¦ useEffectï¼Ÿ

è™½ç„¶æ­¥éª¤2ä¸­æˆ‘ä»¬å·²ç»æ‰‹åŠ¨æ›´æ–°äº† stateï¼Œä½†æ˜¯ä½¿ç”¨ useEffect åŒæ­¥ props æœ‰ä»¥ä¸‹å¥½å¤„ï¼š

1. **æ•°æ®ä¸€è‡´æ€§**
   - ç¡®ä¿å‰ç«¯æ˜¾ç¤ºçš„æ•°æ®ä¸æœåŠ¡å™¨æ•°æ®ä¸€è‡´
   - å¦‚æœå…¶ä»–ç”¨æˆ·ä¹Ÿç‚¹èµäº†ï¼Œåˆ·æ–°æ—¶èƒ½æ­£ç¡®æ˜¾ç¤º

2. **å¤„ç†è¾¹ç¼˜æƒ…å†µ**
   - ç½‘ç»œè¯·æ±‚å¤±è´¥æ—¶ï¼ŒæœåŠ¡å™¨ä¼šè¿”å›åŸå§‹å€¼
   - useEffect ä¼šå°† state å›æ»šåˆ°æ­£ç¡®çš„å€¼

3. **æ”¯æŒå¤–éƒ¨æ›´æ–°**
   - å¦‚æœçˆ¶ç»„ä»¶å› å…¶ä»–åŸå› é‡æ–°è·å–æ•°æ®
   - å­ç»„ä»¶ä¼šè‡ªåŠ¨åŒæ­¥æœ€æ–°å€¼

### ä¹è§‚æ›´æ–° vs æœåŠ¡å™¨åŒæ­¥

æˆ‘ä»¬çš„å®ç°ç»“åˆäº†ä¸¤ç§ç­–ç•¥ï¼š

```typescript
// ä¹è§‚æ›´æ–°ï¼šç«‹å³æ›´æ–° UI
if (voteType === 'up') {
  setUpvotes(upvotes + 1);  // ç”¨æˆ·ç«‹å³çœ‹åˆ°å˜åŒ–
}

// æœåŠ¡å™¨åŒæ­¥ï¼šç¡®ä¿æ•°æ®æ­£ç¡®
if (onVoteChange) {
  onVoteChange();  // è§¦å‘é‡æ–°è·å–ï¼ŒuseEffect ä¼šåŒæ­¥
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… å“åº”é€Ÿåº¦å¿«ï¼ˆç«‹å³æ›´æ–°ï¼‰
- âœ… æ•°æ®å‡†ç¡®ï¼ˆæœåŠ¡å™¨éªŒè¯ï¼‰
- âœ… å¤šç”¨æˆ·åŒæ­¥ï¼ˆè·å–æœ€æ–°æ•°æ®ï¼‰

## ğŸ“‹ ç›¸å…³ä¿®æ”¹

### ä¿®æ”¹çš„æ–‡ä»¶
- `components/vote-buttons.tsx` - æ·»åŠ  useEffect åŒæ­¥é€»è¾‘

### æ”¹åŠ¨å†…å®¹
```diff
- import { useState } from 'react';
+ import { useState, useEffect } from 'react';

  export function VoteButtons({ initialUpvotes, ... }: Props) {
    const [upvotes, setUpvotes] = useState(initialUpvotes);
    const [downvotes, setDownvotes] = useState(initialDownvotes);
    const [userVote, setUserVote] = useState(initialUserVote);
    
+   // å½“çˆ¶ç»„ä»¶ä¼ å…¥æ–°çš„åˆå§‹å€¼æ—¶ï¼Œæ›´æ–°æœ¬åœ° state
+   useEffect(() => {
+     setUpvotes(initialUpvotes);
+     setDownvotes(initialDownvotes);
+     setUserVote(initialUserVote);
+   }, [initialUpvotes, initialDownvotes, initialUserVote]);
    
    // ... å…¶ä»–ä»£ç 
  }
```

## ğŸ§ª æµ‹è¯•åœºæ™¯

ä¿®å¤åè¯·æµ‹è¯•ï¼š

### åœºæ™¯1ï¼šåŸºç¡€ç‚¹èµ
- [ ] ç‚¹å‡»ç‚¹èµæŒ‰é’®
- [ ] æ•°å­—ç«‹å³ä» 0 â†’ 1
- [ ] æŒ‰é’®å˜ä¸ºé«˜äº®çŠ¶æ€ï¼ˆè“è‰²ï¼‰
- [ ] æ˜¾ç¤º"ç‚¹èµæˆåŠŸ"æç¤º

### åœºæ™¯2ï¼šå–æ¶ˆç‚¹èµ
- [ ] å†æ¬¡ç‚¹å‡»ç‚¹èµæŒ‰é’®
- [ ] æ•°å­—ä» 1 â†’ 0
- [ ] æŒ‰é’®æ¢å¤æ™®é€šçŠ¶æ€
- [ ] æ˜¾ç¤º"å·²å–æ¶ˆæŠ•ç¥¨"æç¤º

### åœºæ™¯3ï¼šåˆ‡æ¢æŠ•ç¥¨
- [ ] ç‚¹å‡»ç‚¹èµï¼ˆ0 â†’ 1 èµï¼‰
- [ ] ç‚¹å‡»è¸©ï¼ˆ1 èµ â†’ 0 èµï¼Œ0 è¸© â†’ 1 è¸©ï¼‰
- [ ] æ˜¾ç¤º"æŠ•ç¥¨å·²æ›´æ–°"æç¤º

### åœºæ™¯4ï¼šåˆ·æ–°é¡µé¢
- [ ] ç‚¹èµååˆ·æ–°é¡µé¢
- [ ] ç‚¹èµæ•°ä¿æŒæ­£ç¡®ï¼ˆä»æœåŠ¡å™¨åŠ è½½ï¼‰
- [ ] æŒ‰é’®çŠ¶æ€æ­£ç¡®ï¼ˆå·²ç‚¹èµçŠ¶æ€ï¼‰

### åœºæ™¯5ï¼šå¤šç”¨æˆ·åœºæ™¯
- [ ] ç”¨æˆ·Aç‚¹èµ
- [ ] ç”¨æˆ·Båˆ·æ–°é¡µé¢
- [ ] ç”¨æˆ·Bçœ‹åˆ°æ­£ç¡®çš„ç‚¹èµæ•°

## ğŸ’¡ å…¶ä»–å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¸ä½¿ç”¨å†…éƒ¨ stateï¼ˆå®Œå…¨å—æ§ï¼‰

```typescript
export function VoteButtons({ upvotes, downvotes, userVote }: Props) {
  // ç›´æ¥ä½¿ç”¨ propsï¼Œä¸ä½¿ç”¨ state
  // çˆ¶ç»„ä»¶ç®¡ç†æ‰€æœ‰çŠ¶æ€
  
  const handleVote = async (voteType) => {
    // è°ƒç”¨ API
    // é€šçŸ¥çˆ¶ç»„ä»¶æ›´æ–°
    onVoteChange({ upvotes: upvotes + 1, ... });
  };
}
```

**ä¼˜ç‚¹**ï¼šç®€å•ï¼Œå•ä¸€æ•°æ®æº  
**ç¼ºç‚¹**ï¼šçˆ¶ç»„ä»¶éœ€è¦ç®¡ç†æ›´å¤šçŠ¶æ€ï¼Œä»£ç å¤æ‚

### æ–¹æ¡ˆ2ï¼šä½¿ç”¨ key å¼ºåˆ¶é‡æ–°æ¸²æŸ“

```typescript
<VoteButtons 
  key={`${postType}-${postId}-${question.stats.upvotes}`}
  // ...
/>
```

**ä¼˜ç‚¹**ï¼šè‡ªåŠ¨åŒæ­¥  
**ç¼ºç‚¹**ï¼šæ¯æ¬¡æ›´æ–°éƒ½é‡æ–°åˆ›å»ºç»„ä»¶ï¼Œæ€§èƒ½å·®

### æ–¹æ¡ˆ3ï¼šä½¿ç”¨ useReducer

```typescript
const [state, dispatch] = useReducer(voteReducer, {
  upvotes: initialUpvotes,
  downvotes: initialDownvotes,
  userVote: initialUserVote,
});
```

**ä¼˜ç‚¹**ï¼šæ›´å¥½çš„çŠ¶æ€ç®¡ç†ï¼Œæ”¯æŒå¤æ‚é€»è¾‘  
**ç¼ºç‚¹**ï¼šä»£ç é‡æ›´å¤šï¼Œå¯¹å½“å‰åœºæ™¯è¿‡åº¦è®¾è®¡

## âœ… ç»“è®º

æˆ‘ä»¬é€‰æ‹©äº† **useEffect åŒæ­¥æ–¹æ¡ˆ**ï¼Œå› ä¸ºï¼š

1. âœ… ç®€å•ç›´è§‚ï¼Œæ˜“äºç†è§£
2. âœ… ä¿æŒäº†ä¹è§‚æ›´æ–°çš„æ€§èƒ½ä¼˜åŠ¿
3. âœ… ç¡®ä¿äº†æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§
4. âœ… ä¸ç ´åç°æœ‰çš„ç»„ä»¶ç»“æ„

**ç°åœ¨ç‚¹èµåŠŸèƒ½åº”è¯¥å®Œå…¨æ­£å¸¸å·¥ä½œäº†ï¼** ğŸ‰

---

## ğŸ“– å»¶ä¼¸é˜…è¯»

- [React useState Hook](https://react.dev/reference/react/useState)
- [React useEffect Hook](https://react.dev/reference/react/useEffect)
- [Synchronizing with Effects](https://react.dev/learn/synchronizing-with-effects)
- [You Might Not Need an Effect](https://react.dev/learn/you-might-not-need-an-effect)

