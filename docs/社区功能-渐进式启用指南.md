# 社区功能 - 渐进式启用指南 🚀

## 📌 当前状态

✅ **代码已完全就绪**  
✅ **系统题目正常显示**（即使没有运行数据库迁移）  
⏳ **社区功能待启用**（需要运行数据库迁移）

---

## 🎯 设计理念

### 数据存储结构

```
┌─────────────────────────────────────┐
│      面试真题库（同一界面）         │
├─────────────────────────────────────┤
│                                     │
│  1️⃣ 用户自己的帖子 (置顶)          │
│     ↓ 存储在: user_interview_posts  │
│                                     │
│  2️⃣ 系统预置题目                   │
│     ↓ 存储在: interview_questions   │
│                                     │
│  3️⃣ 其他用户的帖子                 │
│     ↓ 存储在: user_interview_posts  │
│                                     │
└─────────────────────────────────────┘
```

### 三个新数据库表

1. **`user_interview_posts`** - 用户发布的面试题目
2. **`interview_comments`** - 评论（支持系统题 + 用户题）
3. **`interview_votes`** - 点赞/踩（支持系统题 + 用户题）

---

## 🌟 渐进式启用策略

### 阶段1：当前状态（无需迁移）✅

**已有功能**：
- ✅ 查看系统预置的面试真题
- ✅ 筛选、分页功能
- ✅ 折叠/展开题目

**未启用功能**：
- ⏸️ 用户发帖
- ⏸️ 点赞/踩
- ⏸️ 评论讨论

**用户体验**：
- 用户可以正常浏览所有系统题目
- 看不到"发布题目"按钮
- 看不到点赞/踩和评论区

### 阶段2：运行数据库迁移后 🎉

**所有功能全部启用**：
- ✅ 用户可以发布自己的面试题
- ✅ 用户可以点赞/踩任何题目
- ✅ 用户可以评论讨论
- ✅ 用户自己的帖子显示在最前面
- ✅ 系统题目和用户题目混合显示

---

## 🚀 启用步骤

### 方法1：在数据库控制台执行 SQL（推荐）⭐

#### 步骤1：复制 SQL 代码

```sql
-- 用户发布的面试题目表
CREATE TABLE IF NOT EXISTS user_interview_posts (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  company VARCHAR(100) NOT NULL,
  position VARCHAR(100) NOT NULL,
  question_type VARCHAR(50) NOT NULL,
  difficulty VARCHAR(20) NOT NULL,
  interview_date DATE NOT NULL,
  question TEXT NOT NULL,
  recommended_answer TEXT,
  is_anonymous BOOLEAN DEFAULT FALSE,
  status VARCHAR(20) DEFAULT 'active',
  views_count INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMP DEFAULT NOW() NOT NULL
);

-- 评论表
CREATE TABLE IF NOT EXISTS interview_comments (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  post_type VARCHAR(20) NOT NULL,
  post_id INTEGER NOT NULL,
  content TEXT NOT NULL,
  parent_comment_id INTEGER REFERENCES interview_comments(id) ON DELETE CASCADE,
  is_anonymous BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMP DEFAULT NOW() NOT NULL
);

-- 点赞/踩表
CREATE TABLE IF NOT EXISTS interview_votes (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  post_type VARCHAR(20) NOT NULL,
  post_id INTEGER NOT NULL,
  vote_type VARCHAR(10) NOT NULL,
  created_at TIMESTAMP DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMP DEFAULT NOW() NOT NULL,
  UNIQUE(user_id, post_type, post_id)
);

-- 索引优化
CREATE INDEX IF NOT EXISTS idx_user_posts_user_id ON user_interview_posts(user_id);
CREATE INDEX IF NOT EXISTS idx_user_posts_company ON user_interview_posts(company);
CREATE INDEX IF NOT EXISTS idx_user_posts_position ON user_interview_posts(position);
CREATE INDEX IF NOT EXISTS idx_user_posts_status ON user_interview_posts(status);
CREATE INDEX IF NOT EXISTS idx_user_posts_created_at ON user_interview_posts(created_at DESC);

CREATE INDEX IF NOT EXISTS idx_comments_post ON interview_comments(post_type, post_id);
CREATE INDEX IF NOT EXISTS idx_comments_user ON interview_comments(user_id);
CREATE INDEX IF NOT EXISTS idx_comments_parent ON interview_comments(parent_comment_id);
CREATE INDEX IF NOT EXISTS idx_comments_created_at ON interview_comments(created_at DESC);

CREATE INDEX IF NOT EXISTS idx_votes_post ON interview_votes(post_type, post_id);
CREATE INDEX IF NOT EXISTS idx_votes_user ON interview_votes(user_id);
CREATE INDEX IF NOT EXISTS idx_votes_vote_type ON interview_votes(vote_type);
```

#### 步骤2：执行 SQL

1. 访问 **Vercel Dashboard** → 你的项目 → **Storage** → **Neon PostgreSQL**
2. 或访问 **https://console.neon.tech**
3. 打开 **SQL Editor**
4. 粘贴上面的 SQL 代码
5. 点击 **Run** 执行

#### 步骤3：验证

执行成功后，在数据库中应该能看到3个新表：
- `user_interview_posts`
- `interview_comments`
- `interview_votes`

#### 步骤4：刷新网站

刷新你的网站，你会看到：
- ✅ 右上角出现"📝 发布题目"按钮
- ✅ 题目下方有点赞👍和踩👎按钮
- ✅ 展开题目后可以看到评论区

---

## 🔄 工作原理

### API 查询逻辑

```typescript
// 1. 先查询系统题目（interview_questions 表）
const systemQuestions = await db.select().from(interviewQuestions);

// 2. 尝试查询用户发布的题目（user_interview_posts 表）
try {
  const userPosts = await db.select().from(userInterviewPosts);
  // 如果成功，分离出当前用户的帖子和其他用户的帖子
} catch (error) {
  // 如果失败（表不存在），使用空数组，不影响系统题目
  console.log('用户发帖功能未启用');
}

// 3. 合并显示：用户自己的 → 系统题目 → 其他用户的
const allQuestions = [...ownPosts, ...systemQuestions, ...otherUserPosts];
```

### 错误处理机制

✅ **系统题目永远不受影响**
- 即使新表不存在
- 即使查询失败
- 系统题目始终能正常显示

✅ **渐进式增强**
- 运行迁移前：基础功能正常
- 运行迁移后：所有功能启用

---

## 🎯 使用场景

### 场景1：浏览题库（所有用户）

1. 访问"面试真题"页面
2. 使用筛选器按公司、岗位等筛选
3. 点击题目查看详情
4. 查看推荐答案

### 场景2：发布题目（登录用户 + 已迁移）

1. 点击右上角"📝 发布题目"按钮
2. 填写面试信息：
   - 公司、岗位
   - 题目类型、难度
   - 面试时间
   - 题目内容
   - （可选）推荐答案
3. 提交后，题目出现在列表顶部
4. 带有"我的发布"绿色标签

### 场景3：互动讨论（登录用户 + 已迁移）

1. 展开任意题目
2. 点击👍或👎投票
3. 在评论区发表想法
4. 查看其他用户的评论

---

## 📊 数据统计

运行迁移后，每个题目会显示：
- 👍 点赞数
- 👎 踩数
- 💬 评论数
- 📊 总分（点赞 - 踩）

---

## 🔒 安全特性

1. ✅ **身份验证** - 所有写操作需要登录
2. ✅ **频率限制** - 每天最多发布5道题
3. ✅ **内容验证** - 前后端双重验证
4. ✅ **防止重复投票** - 每人每题只能投一次
5. ✅ **级联删除** - 用户删除时自动清理相关数据

---

## 🐛 故障排除

### 问题1：题库显示为空

**原因**：查询失败或数据库中没有题目

**解决**：
1. 检查浏览器控制台是否有错误
2. 访问 `/api/test-questions` 检查数据库连接
3. 检查服务器日志

### 问题2：看不到发帖按钮

**原因**：数据库迁移未运行

**解决**：
1. 按照上面的步骤运行 SQL 迁移
2. 刷新页面

### 问题3：发帖失败

**原因**：
- 未登录
- 超过每天5条限制
- 必填字段未填

**解决**：
1. 确保已登录
2. 检查是否已发布5条
3. 填写所有必填字段（带*号）

---

## 📈 未来扩展

可以轻松添加的功能：
- 编辑/删除自己的帖子
- 举报不当内容
- 通知系统（有人评论时）
- 热门题目排行榜
- 收藏功能
- 回复评论（二级评论）
- 搜索功能增强

---

## ✅ 总结

这个设计的优势：
1. ✅ **渐进式** - 不影响现有功能
2. ✅ **容错性强** - 查询失败不影响系统题目
3. ✅ **用户体验好** - 同一界面显示所有题目
4. ✅ **数据分离** - 系统题和用户题存储在不同表
5. ✅ **易于维护** - 清晰的错误处理和日志

**现在就可以运行迁移，启用完整的社区功能！** 🚀

