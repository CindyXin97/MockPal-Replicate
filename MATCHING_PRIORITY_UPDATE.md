# 匹配推荐优先级更新

## 更新日期
2025-10-17

## 更新内容

### 新增：成就等级排序
在匹配推荐时，每个优先级组内部会按照用户的"面试达人"成就等级进行二级排序。

### 推荐逻辑（更新后）

#### 第一级：优先级分组（保持不变）
1. 🌟 对方已经给你发出邀请 + 练习内容重叠
2. ✨ 练习内容重叠
3. 📊 经验级别相同
4. 💼 工作类型相同
5. 其他

#### 第二级：组内成就等级排序（新增）
在每个优先级组内部，按照以下规则排序：
- **主排序**：经验值从高到低（面试达人等级越高越靠前）
- **次排序**：经验值相同时，按注册时间倒序（新用户优先）

### 成就等级对照表
| 等级 | 图标 | 经验值要求 | 优先级 |
|------|------|-----------|--------|
| 面试导师 | 👑 | 15+ | 最高 |
| 面试达人 | 🌙 | 10-14 | 高 |
| 面试新星 | 🌟 | 5-9 | 中 |
| 面试新手 | ⭐ | 1-4 | 低 |
| 新用户 | 🌱 | 0 | 最低 |

**经验值获取方式**：用户每完成一次成功的模拟面试（feedback 中 interviewStatus='yes'）获得 1 点经验值。

### 示例

假设优先级1组（对方已邀请+内容重叠）中有以下用户：
- 用户A：面试导师，20分 → **第1个显示**
- 用户B：面试达人，12分 → **第2个显示**
- 用户C：面试达人，10分 → **第3个显示**
- 用户D：面试新手，2分 → **第4个显示**

### 技术实现

**文件**：`lib/matching.ts`

**关键改动**：
1. 导入 `getBatchUserAchievements` 函数
2. 批量查询所有候选用户的成就数据（避免N+1查询）
3. 创建成就数据 Map 用于快速查找
4. 定义 `sortByAchievement` 排序函数
5. 对所有5个优先级组分别应用排序

**性能优化**：
- 使用批量查询（`getBatchUserAchievements`）一次性获取所有用户成就
- 使用 Map 数据结构实现 O(1) 查找
- 排序逻辑在内存中完成，不增加数据库查询次数

### 优势

1. ✅ **激励机制**：鼓励用户完成更多面试，提升自己的曝光率
2. ✅ **质量优先**：优先推荐经验丰富的用户，提升匹配质量
3. ✅ **公平性**：在同等级别下，新用户也有机会被优先推荐
4. ✅ **性能优化**：批量查询，不影响系统性能

### 兼容性

- 完全兼容现有数据结构
- 对于没有成就记录的用户，默认经验值为 0（新用户）
- 不影响现有的匹配逻辑和每日限制规则


