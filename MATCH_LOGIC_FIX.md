# åŒ¹é…é€»è¾‘é‡å¤§ä¿®å¤æŠ¥å‘Š

## ğŸ› å‘ç°çš„æ ¸å¿ƒé—®é¢˜

ç”¨æˆ·å‘ç°äº†ä¸€ä¸ªä¸¥é‡çš„é€»è¾‘bugï¼š"è¢«åŠ¨åŒ¹é…é‚€è¯·"æœºåˆ¶å­˜åœ¨é—®é¢˜ã€‚

### é—®é¢˜è¡¨ç°

æ•°æ®åº“ä¸­æœ‰10æ¡ `rejected` çŠ¶æ€çš„åŒ¹é…è®°å½•ï¼Œä½†**æ¥æ”¶æ–¹æ²¡æœ‰ä»»ä½•viewè®°å½•**ï¼š

```
åŒ¹é…#9: ç”¨æˆ·6 â†’ ç”¨æˆ·3 (rejected)
  - å‘èµ·æ–¹(ç”¨æˆ·6)æœ‰viewè®°å½•: âœ…
  - æ¥æ”¶æ–¹(ç”¨æˆ·3)æœ‰viewè®°å½•: âŒ  â† é—®é¢˜ï¼
```

### é—®é¢˜åˆ†æ

å¦‚æœåŒ¹é…çŠ¶æ€æ˜¯ `rejected`ï¼Œåªæœ‰ä¸¤ç§å¯èƒ½ï¼š
1. **æ¥æ”¶æ–¹æ‹’ç»äº†é‚€è¯·** â†’ åº”è¯¥æœ‰æ¥æ”¶æ–¹çš„viewè®°å½• âœ“
2. **å‘èµ·æ–¹æ”¹å˜ä¸»æ„** â†’ ä¸åº”è¯¥æ˜¯rejectedçŠ¶æ€ï¼Œåº”è¯¥åˆ é™¤æˆ–ä¿æŒpending

ä½†æ•°æ®æ˜¾ç¤ºï¼š**æ¥æ”¶æ–¹æ²¡æœ‰viewè®°å½•ï¼ŒçŠ¶æ€å´æ˜¯rejected**ï¼

è¿™è¯´æ˜ï¼š**ä¹‹å‰çš„ä»£ç å…è®¸å‘èµ·æ–¹å•æ–¹é¢æŠŠpendingæ”¹æˆrejected**ã€‚

---

## ğŸ” æ ¹æœ¬åŸå› 

### Bug 1: `rejectMatch` å‡½æ•°æ²¡æœ‰æ£€æŸ¥ç”¨æˆ·èº«ä»½

**ä¹‹å‰çš„ä»£ç **ï¼ˆç¬¬299-304è¡Œï¼‰ï¼š

```typescript
if (existingMatch) {
  // æ›´æ–°çŠ¶æ€ä¸ºæ‹’ç»
  await db
    .update(matches)
    .set({ status: 'rejected', updatedAt: new Date() })
    .where(eq(matches.id, existingMatch.id));
}
```

**é—®é¢˜**ï¼šæ— è®ºå½“å‰ç”¨æˆ·æ˜¯å‘èµ·æ–¹è¿˜æ˜¯æ¥æ”¶æ–¹ï¼Œéƒ½ä¼šç›´æ¥æ›´æ–°ä¸ºrejectedï¼

**é”™è¯¯åœºæ™¯**ï¼š
```
1. ç”¨æˆ·6å‘ç”¨æˆ·3å‘é€é‚€è¯·
   â†’ match: 6â†’3 (pending)
   â†’ view: 6â†’3

2. ç”¨æˆ·6æ”¹å˜ä¸»æ„ï¼Œç‚¹å‡»"X"ï¼ˆæ‹’ç»ï¼‰
   â†’ è°ƒç”¨ rejectMatch(6, 3)
   â†’ æ‰¾åˆ° existingMatch (6â†’3, pending)
   â†’ ç›´æ¥æ›´æ–°ä¸º rejected âŒ
   
ç»“æœï¼š
   â†’ match: 6â†’3 (rejected)
   â†’ view: åªæœ‰6â†’3
   â†’ ç”¨æˆ·3ä»æœªæ“ä½œï¼Œä½†matchå·²ç»æ˜¯rejectedäº†ï¼
```

### Bug 2: `createMatch` å‡½æ•°å…è®¸å‘èµ·æ–¹å•æ–¹é¢æ”¹çŠ¶æ€

**ä¹‹å‰çš„ä»£ç **ï¼ˆç¬¬247-254è¡Œï¼‰ï¼š

```typescript
// è‡ªå·±å·²å‘å‡ºé‚€è¯·ï¼Œç­‰å¾…å¯¹æ–¹å›åº”
if (existingMatch.user1Id === userId && existingMatch.status === 'pending') {
  await db
    .update(matches)
    .set({ status: 'accepted', updatedAt: new Date() })
    .where(eq(matches.id, existingMatch.id));

  return successResponse({ match: true }, 'åŒ¹é…æˆåŠŸï¼');
}
```

**é—®é¢˜**ï¼šå‘èµ·æ–¹é‡å¤ç‚¹å‡»"åŒ¹é…"æŒ‰é’®ï¼Œä¼šå•æ–¹é¢æŠŠpendingæ”¹æˆacceptedï¼

**é”™è¯¯åœºæ™¯**ï¼š
```
1. ç”¨æˆ·Aå‘ç”¨æˆ·Bå‘é€é‚€è¯·
   â†’ match: Aâ†’B (pending)

2. ç”¨æˆ·Aå†æ¬¡ç‚¹å‡»"åŒ¹é…"
   â†’ è°ƒç”¨ createMatch(A, B)
   â†’ æ‰¾åˆ° existingMatch (Aâ†’B, pending)
   â†’ å•æ–¹é¢æ›´æ–°ä¸º accepted âŒ
   
ç»“æœï¼š
   â†’ match: Aâ†’B (accepted)
   â†’ ç”¨æˆ·Bä»æœªæ“ä½œï¼Œä½†å·²ç»"åŒ¹é…æˆåŠŸ"äº†ï¼
```

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: `rejectMatch` - åŒºåˆ†ç”¨æˆ·èº«ä»½

```typescript
if (existingMatch) {
  // æ£€æŸ¥å½“å‰ç”¨æˆ·çš„èº«ä»½
  if (existingMatch.user1Id === userId) {
    // æƒ…å†µ1ï¼šå½“å‰ç”¨æˆ·æ˜¯å‘èµ·æ–¹
    // åœºæ™¯ï¼šç”¨æˆ·Aä¹‹å‰å‘ç”¨æˆ·Bå‘é€äº†pendingé‚€è¯·ï¼Œç°åœ¨æƒ³å–æ¶ˆ
    // æ­£ç¡®åšæ³•ï¼šåˆ é™¤pendingè®°å½•ï¼Œä¸æ˜¯æ”¹æˆrejected
    if (existingMatch.status === 'pending') {
      await db.delete(matches).where(eq(matches.id, existingMatch.id));
      return successResponse({}, 'å·²å–æ¶ˆå¯¹è¯¥ç”¨æˆ·çš„é‚€è¯·');
    } else {
      // å¦‚æœçŠ¶æ€å·²ç»æ˜¯acceptedæˆ–rejectedï¼Œè¯´æ˜å¯¹æ–¹å·²ç»å›åº”äº†
      return { success: false, message: 'è¯¥åŒ¹é…å·²å®Œæˆï¼Œæ— æ³•ä¿®æ”¹' };
    }
  } else if (existingMatch.user2Id === userId) {
    // æƒ…å†µ2ï¼šå½“å‰ç”¨æˆ·æ˜¯æ¥æ”¶æ–¹
    // åœºæ™¯ï¼šç”¨æˆ·Bæ”¶åˆ°ç”¨æˆ·Açš„pendingé‚€è¯·ï¼Œé€‰æ‹©æ‹’ç»
    // æ­£ç¡®åšæ³•ï¼šæ›´æ–°ä¸ºrejected
    await db
      .update(matches)
      .set({ status: 'rejected', updatedAt: new Date() })
      .where(eq(matches.id, existingMatch.id));
    return successResponse({}, 'å·²æ‹’ç»è¯¥åŒ¹é…');
  }
}
```

### ä¿®å¤2: `createMatch` - é˜²æ­¢é‡å¤ç‚¹å‡»æ”¹å˜çŠ¶æ€

```typescript
// è‡ªå·±å·²å‘å‡ºé‚€è¯·ï¼Œç­‰å¾…å¯¹æ–¹å›åº”
if (existingMatch.user1Id === userId && existingMatch.status === 'pending') {
  // ä¸åº”è¯¥æ”¹å˜çŠ¶æ€ï¼åªæ˜¯é‡å¤ç‚¹å‡»è€Œå·²
  return successResponse({ match: false }, 'å·²æ”¶åˆ°ä½ çš„å–œæ¬¢ï¼ç­‰å¾…å¯¹æ–¹å›åº”ã€‚');
}
```

### ä¿®å¤3: `createMatch` - æ­£ç¡®å¤„ç†rejectedçŠ¶æ€é‡æ–°åŒ¹é…

```typescript
if (existingMatch.status === 'rejected') {
  // éœ€è¦æ£€æŸ¥æ˜¯è°æ‹’ç»çš„
  if (existingMatch.user1Id === userId) {
    // æƒ…å†µ1ï¼šè‡ªå·±ä¹‹å‰å‘èµ·å¹¶æ‹’ç»äº†å¯¹æ–¹ï¼ˆæˆ–è¢«å¯¹æ–¹æ‹’ç»ï¼‰
    // ç°åœ¨æƒ³é‡æ–°åŒ¹é…ï¼Œæ›´æ–°ä¸ºpending
    await db.update(matches)
      .set({ 
        status: 'pending',
        user1Id: userId,
        user2Id: targetUserId,
        updatedAt: new Date() 
      })
      .where(eq(matches.id, existingMatch.id));
    return successResponse({ match: false }, 'å·²æ”¶åˆ°ä½ çš„å–œæ¬¢ï¼ç­‰å¾…å¯¹æ–¹å›åº”ã€‚');
  } else {
    // æƒ…å†µ2ï¼šå¯¹æ–¹ä¹‹å‰å‘èµ·å¹¶æ‹’ç»äº†è‡ªå·±
    // ç°åœ¨è‡ªå·±æƒ³åŒ¹é…å¯¹æ–¹ï¼Œéœ€è¦åˆ›å»ºæ–°çš„pending
    await db.insert(matches).values({
      user1Id: userId,
      user2Id: targetUserId,
      status: 'pending',
    });
    return successResponse({ match: false }, 'å·²æ”¶åˆ°ä½ çš„å–œæ¬¢ï¼ç­‰å¾…å¯¹æ–¹å›åº”ã€‚');
  }
}
```

---

## ğŸ“‹ æ­£ç¡®çš„ä¸šåŠ¡é€»è¾‘

### åœºæ™¯1: ç”¨æˆ·Aé€‰æ‹©ç”¨æˆ·Bï¼ˆç¬¬ä¸€æ¬¡ï¼‰

```
æ“ä½œï¼šç”¨æˆ·Aç‚¹å‡»"â¤ï¸"åŒ¹é…ç”¨æˆ·B
ç»“æœï¼š
  - viewè®°å½•: Aâ†’B âœ“
  - matchè®°å½•: Aâ†’B (pending) âœ“
  - æç¤º: "å·²æ”¶åˆ°ä½ çš„å–œæ¬¢ï¼ç­‰å¾…å¯¹æ–¹å›åº”ã€‚"
```

### åœºæ™¯2: ç”¨æˆ·Bçœ‹åˆ°å¹¶æ¥å—

```
æ“ä½œï¼šç”¨æˆ·Bçœ‹åˆ°ç”¨æˆ·Açš„é‚€è¯·ï¼Œç‚¹å‡»"â¤ï¸"æ¥å—
ç»“æœï¼š
  - viewè®°å½•: Aâ†’B, Bâ†’A âœ“
  - matchè®°å½•: Aâ†”B (accepted) âœ“
  - æç¤º: "åŒ¹é…æˆåŠŸï¼"
```

### åœºæ™¯3: ç”¨æˆ·Bçœ‹åˆ°å¹¶æ‹’ç»

```
æ“ä½œï¼šç”¨æˆ·Bçœ‹åˆ°ç”¨æˆ·Açš„é‚€è¯·ï¼Œç‚¹å‡»"âœ–ï¸"æ‹’ç»
ç»“æœï¼š
  - viewè®°å½•: Aâ†’B, Bâ†’A âœ“
  - matchè®°å½•: Aâ†’B (rejected) âœ“
  - æç¤º: "å·²æ‹’ç»è¯¥åŒ¹é…"
```

### åœºæ™¯4: ç”¨æˆ·Aå–æ¶ˆé‚€è¯·

```
æ“ä½œï¼šç”¨æˆ·Aä¹‹å‰å‘ç”¨æˆ·Bå‘é€äº†é‚€è¯·ï¼Œç°åœ¨æ”¹å˜ä¸»æ„ï¼Œç‚¹å‡»"âœ–ï¸"
ç»“æœï¼š
  - viewè®°å½•: Aâ†’B âœ“
  - matchè®°å½•: åˆ é™¤ âœ“
  - æç¤º: "å·²å–æ¶ˆå¯¹è¯¥ç”¨æˆ·çš„é‚€è¯·"
```

### åœºæ™¯5: ç”¨æˆ·Aé‡å¤ç‚¹å‡»

```
æ“ä½œï¼šç”¨æˆ·Aå·²ç»å‘ç”¨æˆ·Bå‘é€äº†é‚€è¯·ï¼Œå†æ¬¡ç‚¹å‡»"â¤ï¸"
ç»“æœï¼š
  - viewè®°å½•: Aâ†’B âœ“
  - matchè®°å½•: Aâ†’B (pending) âœ“ (çŠ¶æ€ä¸å˜)
  - æç¤º: "å·²æ”¶åˆ°ä½ çš„å–œæ¬¢ï¼ç­‰å¾…å¯¹æ–¹å›åº”ã€‚"
```

### åœºæ™¯6: ç”¨æˆ·Aç¬¬ä¸€æ¬¡çœ‹åˆ°å°±æ‹’ç»

```
æ“ä½œï¼šç”¨æˆ·Aæµè§ˆåˆ°ç”¨æˆ·Bï¼Œç¬¬ä¸€æ¬¡è§é¢å°±ç‚¹å‡»"âœ–ï¸"
ç»“æœï¼š
  - viewè®°å½•: Aâ†’B âœ“
  - matchè®°å½•: Aâ†’B (rejected) âœ“
  - è¯´æ˜: è¿™æ˜¯Aä¸»åŠ¨æ‹’ç»ï¼Œä¸æ˜¯Bçš„é‚€è¯·
```

---

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

### 1. MatchçŠ¶æ€çš„å«ä¹‰

- **pending**: å‘èµ·æ–¹å‘æ¥æ”¶æ–¹å‘é€é‚€è¯·ï¼Œç­‰å¾…å›åº”
  - åªæœ‰å‘èµ·æ–¹æœ‰viewè®°å½•
  - æ¥æ”¶æ–¹è¿˜æ²¡æ“ä½œ

- **accepted**: åŒæ–¹éƒ½åŒæ„åŒ¹é…
  - åŒæ–¹éƒ½æœ‰viewè®°å½•
  - å¯ä»¥çœ‹åˆ°è”ç³»æ–¹å¼

- **rejected**: æœ‰äººæ‹’ç»äº†åŒ¹é…
  - å¦‚æœæ˜¯æ¥æ”¶æ–¹æ‹’ç»ï¼šåŒæ–¹éƒ½æœ‰viewè®°å½•
  - å¦‚æœæ˜¯å‘èµ·æ–¹ç¬¬ä¸€æ¬¡å°±æ‹’ç»ï¼šåªæœ‰å‘èµ·æ–¹æœ‰viewè®°å½•

### 2. æ“ä½œæƒé™

| æ“ä½œ | å‘èµ·æ–¹ | æ¥æ”¶æ–¹ |
|------|--------|--------|
| åˆ›å»ºpending | âœ… | âœ… |
| å–æ¶ˆpending | âœ… (åˆ é™¤è®°å½•) | âŒ |
| æ¥å—pending | âŒ | âœ… (â†’accepted) |
| æ‹’ç»pending | âŒ | âœ… (â†’rejected) |
| ç¬¬ä¸€æ¬¡å°±æ‹’ç» | âœ… (åˆ›å»ºrejected) | âœ… (åˆ›å»ºrejected) |

### 3. Viewè®°å½•è§„åˆ™

- **æ¯æ¬¡ç‚¹å‡»æ“ä½œï¼ˆâ¤ï¸æˆ–âœ–ï¸ï¼‰éƒ½å¿…é¡»å…ˆåˆ›å»ºviewè®°å½•**
- **æ¥æ”¶æ–¹å›åº”é‚€è¯·æ—¶ï¼Œä¹Ÿè¦åˆ›å»ºviewè®°å½•**
- **viewè®°å½•è®¡å…¥æ¯æ—¥4æ¬¡é™åˆ¶**
- **åŒ…æ‹¬å›åº”pendingé‚€è¯·ä¹Ÿè®¡å…¥é™åˆ¶**

### 4. "è¢«åŠ¨åŒ¹é…é‚€è¯·"çš„æ­£ç¡®ç†è§£

**âŒ é”™è¯¯ç†è§£**ï¼š
- æ”¶åˆ°é‚€è¯·å°±æ˜¯"è¢«åŠ¨åŒ¹é…"
- å¯ä»¥å…è´¹çœ‹åˆ°å¯¹æ–¹ä¿¡æ¯
- ä¸è®¡å…¥æ¯æ—¥é™åˆ¶

**âœ… æ­£ç¡®ç†è§£**ï¼š
- æ”¶åˆ°pendingé‚€è¯·åªæ˜¯"ä¼˜å…ˆå±•ç¤º"
- ç‚¹å‡»æ“ä½œæ—¶ï¼Œä»ç„¶è¦è®¡å…¥æ¯æ—¥é™åˆ¶
- ä»ç„¶è¦åˆ›å»ºviewè®°å½•
- æ²¡æœ‰"å…è´¹"æ“ä½œ

---

## ğŸ”§ å†å²æ•°æ®æ¸…ç†

å‘ç°çš„10æ¡ä¸ä¸€è‡´è®°å½•ï¼ˆrejectedä½†æ¥æ”¶æ–¹æ— viewè®°å½•ï¼‰ï¼š

```
1. åŒ¹é…#13: ç”¨æˆ·5 â†’ ç”¨æˆ·1 (rejected)
2. åŒ¹é…#38: ç”¨æˆ·2 â†’ ç”¨æˆ·8 (rejected)
3. åŒ¹é…#7: ç”¨æˆ·6 â†’ ç”¨æˆ·5 (rejected)
4. åŒ¹é…#8: ç”¨æˆ·6 â†’ ç”¨æˆ·4 (rejected)
5. åŒ¹é…#9: ç”¨æˆ·6 â†’ ç”¨æˆ·3 (rejected)
6. åŒ¹é…#10: ç”¨æˆ·5 â†’ ç”¨æˆ·4 (rejected)
7. åŒ¹é…#11: ç”¨æˆ·5 â†’ ç”¨æˆ·3 (rejected)
8. åŒ¹é…#12: ç”¨æˆ·5 â†’ ç”¨æˆ·2 (rejected)
9. åŒ¹é…#15: ç”¨æˆ·7 â†’ ç”¨æˆ·5 (rejected)
10. åŒ¹é…#17: ç”¨æˆ·7 â†’ ç”¨æˆ·3 (rejected)
```

**å»ºè®®å¤„ç†**ï¼š
1. ä¿ç•™è¿™äº›å†å²æ•°æ®ï¼ˆä½œä¸ºbugçš„è¯æ®ï¼‰
2. æˆ–è€…åˆ é™¤è¿™äº›rejectedè®°å½•ï¼Œè®©ç”¨æˆ·å¯ä»¥é‡æ–°åŒ¹é…

---

## âœ… ä¿®å¤å®Œæˆ

- [x] ä¿®å¤ `rejectMatch` å‡½æ•° - åŒºåˆ†ç”¨æˆ·èº«ä»½
- [x] ä¿®å¤ `createMatch` å‡½æ•° - é˜²æ­¢é‡å¤ç‚¹å‡»æ”¹çŠ¶æ€
- [x] ä¿®å¤ `createMatch` å‡½æ•° - æ­£ç¡®å¤„ç†rejectedé‡æ–°åŒ¹é…
- [x] æ— linteré”™è¯¯
- [x] ä¸šåŠ¡é€»è¾‘æ¸…æ™°æ–‡æ¡£åŒ–

**ä¿®å¤æ—¥æœŸ**: 2025-10-09  
**ä¿®å¤æ–‡ä»¶**: `lib/matching.ts`  
**å½±å“å‡½æ•°**: `createMatch`, `rejectMatch`

