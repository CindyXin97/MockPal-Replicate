# 推荐逻辑完整说明

## 📋 核心逻辑

### 1. 浏览轮次判断

系统会自动判断用户处于**第一轮**还是**第二轮**浏览：

```typescript
浏览完所有人 = 有view记录的不同用户数 >= 总用户数 - 1
```

**示例**：
- 系统有12个用户
- 需要浏览 12 - 1 = 11 人（排除自己）
- 当用户浏览了11个不同的人 → 进入第二轮

---

## 🔄 第一轮推荐（首次浏览）

### 排除规则

```
排除列表 = 所有浏览过的用户 + 今日已浏览的用户 + 自己
例外：对方发起的pending邀请（优先展示，但不排除）
```

### 特点

✅ **每个用户只出现一次**
- 一旦浏览过（有view记录），就不会再推荐
- 确保用户不会重复看到同一个人

✅ **对方的pending邀请优先展示**
- 即使你还没浏览过对方，但如果对方向你发了邀请
- 对方会优先出现在推荐列表最前面
- **重要**：点击操作时仍然计入每日4次限制

✅ **避免重复推荐**
- 解决了之前"第二天再次看到同一个人"的bug

### 示例

```
Day 1:
  用户A浏览: [B, C, D, E]（4次，达到每日限制）
  结果:
    - view记录: A→B, A→C, A→D, A→E
    - 排除列表: [B, C, D, E, A自己]

Day 2:
  用户A浏览: 推荐 [F, G, H, I]
  结果:
    - 不会再看到B、C、D、E ✓
    - 看到新的用户 ✓
```

### 例外：对方的pending邀请

```
Day 1:
  用户X向用户A发送pending邀请
  结果:
    - view: X→A ✓
    - match: X→A (pending) ✓

Day 2:
  用户A登录
  结果:
    - 用户X被优先推荐（即使A从未浏览过X）✓
    - 用户A点击操作 → 创建 view: A→X ✓
    - 计入每日限制（4次之一）✓
```

---

## 🔁 第二轮推荐（二次匹配机会）

### 触发条件

```
用户浏览过的不同用户数 >= 总用户数 - 1
```

### 排除规则

```
排除列表 = accepted用户 + 今日已浏览的用户 + 自己
```

### 特点

✅ **只排除accepted用户**
- 已成功匹配的用户永久排除
- 这些用户已在"成功匹配"列表中

✅ **rejected和pending用户可重新出现**
- 之前rejected的：给双方第二次机会
- 之前pending的：如果对方还没回应，可以重新看到

✅ **对方的pending邀请仍优先**
- 优先级排序保持不变

### 示例

```
第一轮完成后:
  用户A浏览了所有11人
  结果:
    - accepted: [B, C]（2人）
    - rejected: [D, E, F]（3人）
    - pending: [G]（1人）
    - 其他: [H, I, J, K]（4人）

第二轮开始:
  可重新推荐:
    - rejected用户: D, E, F ✓
    - pending用户: G ✓
    - 其他用户: H, I, J, K ✓
  永久排除:
    - accepted用户: B, C ✗
```

---

## 🎯 优先级排序

无论第一轮还是第二轮，推荐列表都按以下优先级排序：

```
1. 对方已发pending邀请 + 练习内容重叠
2. 练习内容重叠
3. 岗位和经验都相同
4. 其他用户
```

**说明**：
- 对方的pending邀请**永远排在最前面**
- 确保用户不会错过别人的邀请

---

## 📊 每日限制

### 规则

✅ **每天最多浏览4个用户**
- 包括主动浏览的新用户
- **包括回应对方pending邀请的用户**

✅ **每次点击操作都计入限制**
- 点击❤️（匹配）→ 计入 ✓
- 点击✖️（拒绝）→ 计入 ✓
- 回应pending邀请 → 也计入 ✓

✅ **每日自动重置**
- 使用美东时区（EST）计算日期
- 每天凌晨12点自动重置

### 示例

```
今日浏览:
  1. 用户B（新用户）→ 1/4 ✓
  2. 用户C（pending邀请）→ 2/4 ✓
  3. 用户D（新用户）→ 3/4 ✓
  4. 用户E（新用户）→ 4/4 ✓
  5. 用户F → ❌ 被拒绝："今日浏览次数已达上限"
```

---

## 🔍 Match状态含义

### pending

```
含义：发起方向接收方发送邀请，等待回应
特点：
  - 只有发起方有view记录
  - 接收方还没操作
  - 接收方登录时会优先看到
```

### accepted

```
含义：双方都同意匹配
特点：
  - 双方都有view记录
  - 可以看到联系方式
  - 永久排除（不会再推荐）
```

### rejected

```
含义：有人拒绝了匹配
特点：
  - 如果是接收方拒绝：双方都有view记录
  - 如果是发起方第一次就拒绝：只有发起方有view记录
  - 第一轮：被排除
  - 第二轮：可以重新出现（第二次机会）
```

---

## 🐛 解决的问题

### 问题1：重复推荐

**之前**：
- 第一天浏览了用户B（创建pending）
- 第二天又看到用户B
- 用户体验差

**现在**：
- 第一天浏览了用户B
- 第二天不会再看到B
- 直到浏览完所有人才可能再次出现 ✓

### 问题2：发起方可以单方面reject

**之前**：
- 用户A向B发pending
- 用户A改变主意，点"X"
- 状态变成rejected（错误！）

**现在**：
- 用户A向B发pending
- 用户A改变主意，点"X"
- 删除pending记录（正确！）✓

### 问题3：pending邀请不计入限制

**之前**：
- 可能有人认为pending邀请是"免费"操作
- 不占用每日浏览次数

**现在**：
- 明确：pending邀请只是优先展示
- 操作时仍计入每日4次限制 ✓

---

## 📝 操作规则总结

| 操作 | 发起方 | 接收方 | View记录 | 计入限制 |
|------|--------|--------|----------|----------|
| 第一次匹配 | A点❤️ | - | A→B | ✓ |
| 回应邀请（接受） | - | B点❤️ | B→A | ✓ |
| 回应邀请（拒绝） | - | B点✖️ | B→A | ✓ |
| 取消邀请 | A点✖️ | - | 无新记录 | ✓ |
| 第一次拒绝 | A点✖️ | - | A→B | ✓ |
| 重复点击 | A再点❤️ | - | 无新记录 | ✓ |

---

## ✅ 验证清单

### 第一轮浏览
- [ ] 每个用户只出现一次
- [ ] 对方的pending邀请优先展示
- [ ] 浏览过的用户不会重复出现
- [ ] 每日限制4次严格执行
- [ ] 回应pending邀请也计入限制

### 第二轮浏览
- [ ] 只排除accepted用户
- [ ] rejected用户可重新出现
- [ ] pending用户可重新出现
- [ ] 每日限制4次严格执行

### Match操作
- [ ] 发起方不能单方面reject
- [ ] 接收方可以拒绝pending
- [ ] 发起方可以取消pending（删除记录）
- [ ] 重复点击不改变状态

---

**修复完成日期**：2025-10-09  
**修复文件**：`lib/matching.ts`  
**影响函数**：`getPotentialMatches`, `createMatch`, `rejectMatch`

